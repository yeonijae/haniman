# 타이머 동기화 테스트 시나리오

## 준비
1. 브라우저 2개 탭/창 준비 (탭A, 탭B)
2. 각각 로그인
3. 둘 다 "치료실 관리" 화면으로 이동

## 테스트 1: 환자 배정 동기화
**탭A:**
- 대기 환자를 베드에 드래그 & 드롭

**기대 결과:**
- ✅ 탭A: 환자가 베드에 배정되고 치료 항목들이 보임
- ✅ 탭B: 1-2초 내로 같은 베드에 환자가 나타남
- ✅ 콘솔: "✅ 치료실 DB 저장 완료" 메시지

## 테스트 2: 타이머 시작 동기화
**탭A:**
- 배정된 환자의 첫 번째 치료 항목의 타이머 클릭 (시작)

**기대 결과:**
- ✅ 탭A: 타이머가 카운트다운 시작
- ✅ 탭B: 1-2초 내로 같은 타이머가 running 상태로 변경
- ✅ 탭B: 타이머가 독립적으로 카운트다운됨
- ✅ 콘솔: "✅ 치료실 DB 저장 완료" 메시지

## 테스트 3: 타이머 정지 동기화
**탭B:**
- running 중인 타이머 클릭 (정지)

**기대 결과:**
- ✅ 탭B: 타이머가 paused 상태로 변경, 경과 시간 저장됨
- ✅ 탭A: 1-2초 내로 같은 타이머가 paused로 변경
- ✅ 양쪽 탭: 같은 경과 시간 표시
- ✅ 콘솔: "✅ 치료실 DB 저장 완료" 메시지

## 테스트 4: 타이머 재개 동기화
**탭A:**
- paused 상태의 타이머 재생 버튼 클릭

**기대 결과:**
- ✅ 탭A: 타이머가 이전 경과 시간부터 이어서 카운트다운
- ✅ 탭B: 1-2초 내로 running 상태로 변경
- ✅ 양쪽 탭: 경과 시간이 동일하게 증가

## 테스트 5: 치료 완료 동기화
**탭B:**
- paused 상태의 타이머에서 완료(✓✓) 버튼 클릭

**기대 결과:**
- ✅ 탭B: 치료 항목이 완료(✓) 표시
- ✅ 탭A: 1-2초 내로 같은 치료 항목이 완료 상태로 변경
- ✅ 콘솔: "✅ 치료실 DB 저장 완료" 메시지

## 테스트 6: 세션 완료 동기화
**탭A:**
- 베드 우클릭 → "치료완료" 선택

**기대 결과:**
- ✅ 탭A: 베드가 "청소필요" 상태로 변경
- ✅ 탭B: 1-2초 내로 같은 베드가 "청소필요" 상태
- ✅ 환자가 결제 대기로 이동

## 테스트 7: 청소 완료 동기화
**탭B:**
- "청소필요" 베드 클릭 → "청소중" 상태로 변경
- 다시 클릭 → "사용가능" 상태로 변경

**기대 결과:**
- ✅ 탭A: 각 단계마다 1-2초 내로 동기화
- ✅ 양쪽 탭: 베드가 "사용가능" 상태, 모든 데이터 초기화
- ✅ DB에서 session_treatments 데이터 삭제됨

## 테스트 8: 로컬 타이머 보존 (중요!)
**탭A:**
- 타이머 시작

**탭B:**
- 다른 치료 항목의 타이머 시작

**기대 결과:**
- ✅ 탭A: 자신이 시작한 타이머는 계속 running 상태 유지
- ✅ 탭B에서 시작한 타이머는 DB에서 로드 시 paused로 변환됨 (useTreatmentRooms.ts:73-84)
- ✅ 각 클라이언트는 자신이 실행 중인 타이머만 로컬에서 관리

## 문제 발생 시 확인사항

### 동기화가 안 될 때
1. **Supabase 실시간 구독 확인**
   - 콘솔에 "❌ 실시간 치료실 데이터 로드 오류" 메시지가 있는지 확인
   - Supabase 대시보드에서 Realtime 기능이 활성화되어 있는지 확인

2. **DB 저장 확인**
   - 콘솔에 "✅ 치료실 DB 저장 완료" 메시지가 있는지 확인
   - Supabase Table Editor에서 `treatment_rooms`, `session_treatments` 테이블 직접 확인

3. **네트워크 확인**
   - 개발자 도구 → Network 탭에서 Supabase API 호출 확인
   - WebSocket 연결 확인 (Realtime)

### 타이머가 사라질 때
- ❌ 이전 버그: closure 문제 → **해결됨**
- 확인: `saveTreatmentRoomToDB`가 직접 room 객체를 받는지 확인

### 타이머가 즉시 완료될 때
- ❌ 이전 버그: DB의 running + 과거 startTime → **해결됨**
- 확인: `useTreatmentRooms.ts:73-84`에서 running → paused 변환 로직 확인

## 성공 기준
- ✅ 모든 테스트 시나리오에서 1-2초 내로 동기화
- ✅ 각 클라이언트가 독립적으로 타이머 카운트다운
- ✅ 타이머 상태(running/paused/completed)가 정확히 동기화
- ✅ 경과 시간(elapsedSeconds)이 정확히 동기화
- ✅ DB에 orphan 레코드가 남지 않음
